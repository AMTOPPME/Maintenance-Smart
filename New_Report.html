<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Maintenance Smart | Maintenance Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Apply theme & style from portal -->
  <script>
    (function () {
      // light / dark
      const storedTheme = localStorage.getItem('ms-theme');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = storedTheme || (prefersDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);

      // style: blue / panther / hangyodon
      const style = localStorage.getItem('ms-style') || 'blue';
      document.documentElement.setAttribute('data-style', style);
    })();
  </script>

  <style>
    :root {
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --border-subtle: #e5e7eb;
      --accent: #2563eb;
      --accent-hover: #1d4ed8;
      --text: #111827;
      --text-soft: #6b7280;
      --radius-xl: 16px;
      --shadow-soft-sm: 0 8px 20px rgba(15,23,42,0.06);
      --small-font: 13px;
      --xsmall-font: 11px;
    }

    /* Dark mode */
    html[data-theme="dark"] {
      --bg: #020617;
      --card-bg: #020617;
      --border-subtle: #1f2937;
      --accent: #60a5fa;
      --accent-hover: #3b82f6;
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --shadow-soft-sm: 0 8px 20px rgba(0,0,0,0.75);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 15px;
      background:
        radial-gradient(circle at top, rgba(129,140,248,0.14), transparent),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
      -webkit-text-size-adjust: 100%;
      transition: background .25s ease, color .25s ease;
    }

    /* style 背景：跟 PC Manager 一致 */
    html[data-style="panther"] body {
      background:
        radial-gradient(circle at top, rgba(244,114,182,.28), transparent),
        var(--bg);
    }
    html[data-style="hangyodon"] body {
      background:
        radial-gradient(circle at top, rgba(56,189,248,.35), transparent),
        var(--bg);
    }

    /* Side characters */
    .side-panther,
    .side-hangyodon{
      position:fixed;
      top:50%;
      transform:translateY(-50%);
      width:360px;
      opacity:.9;
      z-index:1;
      pointer-events:none;
      user-select:none;
      display:none;
      transition:transform .25s ease, opacity .25s ease;
    }
    .side-panther.left{left:1.5%;transform:translateY(-50%) scaleX(1)}
    .side-panther.right{right:1.5%;transform:translateY(-50%) scaleX(1)}
    .side-hangyodon.left{left:1.5%;transform:translateY(-50%) scaleX(-1)}
    .side-hangyodon.right{right:1.5%;transform:translateY(-50%) scaleX(-1)}

    html[data-style="panther"] .side-panther{display:block;}
    html[data-style="hangyodon"] .side-hangyodon{display:block;}

    /* 手機：只留中間一隻 */
    @media (max-width: 900px){
      html[data-style="panther"] .side-panther.left,
      html[data-style="hangyodon"] .side-hangyodon.left{
        display:none !important;
      }

      html[data-style="panther"] .side-panther.right,
      html[data-style="hangyodon"] .side-hangyodon.right{
        display:block !important;
        position:fixed !important;
        left:50% !important;
        right:auto !important;
        top:50% !important;
        transform:translate(-50%, -50%) !important;
        width:260px;
        opacity:0.9;
        pointer-events:none;
        z-index:1;
      }
    }

    .page {
      position:relative;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px 16px 32px;
      z-index:2;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-xl);
      border: 1px solid var(--border-subtle);
      padding: 16px 14px 14px;
      box-shadow: var(--shadow-soft-sm);
      margin-bottom: 14px;
      transition: background .25s ease, border-color .25s ease, box-shadow .25s ease;
    }

    .card h2 {
      margin: 0 0 4px;
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
    }

    .card-subtitle {
      font-size: var(--small-font);
      color: var(--text-soft);
      margin-bottom: 10px;
    }

    /* Form layout */
    .form-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .form-row > div{
      flex:1;
      min-width:140px;
    }

    label{
      display:block;
      font-size:var(--xsmall-font);
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--text-soft);
      margin-bottom:3px;
    }

    input, select, textarea{
      width:100%;
      font-size:var(--small-font);
      padding:7px 9px;
      border-radius:10px;
      border:1px solid #d1d5db;
      background:#ffffff;
      color:var(--text);
      transition:border-color .15s ease, box-shadow .15s ease, background .15s ease, transform .05s ease;
      font-family:inherit;
    }
    html[data-theme="dark"] input,
    html[data-theme="dark"] select,
    html[data-theme="dark"] textarea{
      background:#020617;
      border-color:#1f2937;
      color:var(--text);
    }

    input::placeholder,
    textarea::placeholder{
      color:#9ca3af;
    }

    input:focus, select:focus, textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 2px rgba(37,99,235,.14);
      outline:none;
      transform:translateY(-1px);
      background:#ffffff;
    }
    html[data-theme="dark"] input:focus,
    html[data-theme="dark"] select:focus,
    html[data-theme="dark"] textarea:focus{
      background:#020617;
    }

    textarea{
      min-height:90px;
      resize:vertical;
    }

    .btn {
      cursor: pointer;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: var(--xsmall-font);
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s ease;
      background: #e5e7eb;
      color: #111827;
      font-weight:600;
    }

    .btn:hover {
      background: #d1d5db;
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(148,163,253,0.35);
    }

    .btn-primary {
      background: var(--accent);
      color: #ffffff;
      box-shadow: 0 4px 12px rgba(37,99,235,0.35);
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    .btn-row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:6px;
    }

    .status-text{
      margin-top:8px;
      font-size:var(--xsmall-font);
      color:var(--text-soft);
      line-height:1.4;
    }
    .status-text strong{
      color:var(--accent);
    }

    /* Back to Top （表單頁也順便放一顆）*/
    #backToTop {
      position: fixed;
      bottom: 22px;
      right: 22px;
      width: 58px;
      height: 58px;
      border-radius: 50%;
      border: none;
      background: var(--accent);
      color: #fff;
      font-size: 22px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 20px rgba(0,0,0,0.25);
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s ease, transform .25s ease, box-shadow .25s ease;
    }

    #backToTop.visible {
      opacity: 1;
      pointer-events: auto;
    }

    #backToTop:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 28px rgba(0,0,0,0.30);
    }

    html[data-style="panther"] #backToTop {
      background: transparent;
      background-image: url("pinkpanther2.png");
      background-size: 100% 100%;
      background-position: center;
      color: transparent;
      border: none;
    }

    html[data-style="hangyodon"] #backToTop {
      background: transparent;
      background-image: url("hangyodon2.png");
      background-size: 100% 100%;
      background-position: center;
      color: transparent;
      border: none;
    }
    /* 給有 form-row-half 的 row：先把 min-width 拿掉 */
    .form-row.form-row-half > div {
      min-width: 0;
    }

    /* 手機～中小螢幕：強制各 50% 寬 */
    @media (max-width: 900px) {
      .form-row.form-row-half {
        justify-content: space-between;
      }
      .form-row.form-row-half > div {
        flex: 0 0 calc(50% - 5px);
        max-width: calc(50% - 5px);
      }
    }


    @media print{
      body{
        background:#ffffff !important;
        -webkit-print-color-adjust:exact;
        print-color-adjust:exact;
      }
      .side-panther,
      .side-hangyodon,
      #backToTop{
        display:none !important;
      }
      .page{
        max-width:100%;
        padding:0;
      }
      .card{
        box-shadow:none;
        border-radius:0;
        margin:0 0 8px;
      }
    }
  </style>
</head>
<body>

  <!-- side characters -->
  <img src="pinkpanther1.png" alt="Pink Panther Left" class="side-panther left">
  <img src="pinkpanther2.png" alt="Pink Panther Right" class="side-panther right">
  <img src="hangyodon1.png" alt="Hangyodon Left" class="side-hangyodon left">
  <img src="hangyodon2.png" alt="Hangyodon Right" class="side-hangyodon right">

  <div class="page">
    <div class="card">
      <h2>Maintenance report</h2>
      <div class="card-subtitle">
        Fill this form after each maintenance task. Data is stored in this browser
        as <strong>ms-maintenance-logs</strong>. Use the JSON download button for backup / reporting.
      </div>

<!-- DATE 一整行 -->
<div class="form-row">
  <div>
    <label for="dateInput">Date</label>
    <input type="date" id="dateInput">
  </div>
</div>

<!-- LINE 一整行 -->
<div class="form-row">
  <div>
    <label for="lineInput">Line</label>
    <select id="lineInput">
      <option value="Line1">Line 1</option>
      <option value="Line2">Line 2</option>
      <option value="Line3">Line 3</option>
      <option value="Line4">Line 4</option>
      <option value="Reclaim">Reclaim</option>
    </select>
  </div>
</div>

<div class="form-row form-row-half">
  <div>
    <label for="sectionInput">Section</label>
    <select id="sectionInput">
      <option value="">Select…</option>
      <option value="MCC">MCC</option>
      <option value="Control Room">Control Room</option>
      <option value="Field">Field</option>
      <option value="Server Room">Server Room</option>
      <option value="Other">Other</option>
    </select>
  </div>
  <div>
    <label for="equipInput">Asset ID (PC-xxx)</label>
    <input
      type="text"
      id="equipInput"
      placeholder="e.g. PC-001, PC-023, PC-120">
  </div>
</div>

<div class="form-row form-row-half">
  <div>
    <label for="locFromInput">Location From</label>
    <input type="text" id="locFromInput" placeholder="e.g. Line 2 MCC">
  </div>
  <div>
    <label for="locToInput">Location To</label>
    <input type="text" id="locToInput" placeholder="e.g. Line 2 control room">
  </div>
</div>


      <div class="form-row">
        <div>
          <label for="catInput">Category</label>
          <select id="catInput">
            <option>Electrical</option>
            <option>Mechanical</option>
            <option>Instrument</option>
            <option>Network</option>
            <option>Software</option>
            <option>Other</option>
          </select>
        </div>
        <div>
          <label for="downInput">Downtime (min)</label>
          <input type="number" id="downInput" min="0" placeholder="e.g. 30">
        </div>
      </div>

      <div class="form-row">
        <div>
          <label for="rootInput">Root cause</label>
          <textarea id="rootInput" placeholder="Describe what caused the failure…"></textarea>
        </div>
      </div>

      <div class="form-row">
        <div>
          <label for="actionInput">Action taken</label>
          <textarea id="actionInput" placeholder="Describe what you did to fix the issue…"></textarea>
        </div>
      </div>

      <div class="btn-row">
        <button class="btn btn-primary" type="button" onclick="saveRecord()">Submit record</button>
        <button class="btn" type="button" onclick="downloadJson()">Download JSON</button>
      </div>

      <div class="status-text" id="status"></div>
    </div>
  </div>

  <!-- Back to Top button -->
  <button id="backToTop" title="Back to Top">↑</button>

  <script>
    // Back to top (跟 PC Manager 一樣)
    (function(){
      const btn = document.getElementById('backToTop');
      if (!btn) return;
      const THRESHOLD = 250;
      function updateVisibility(){
        if (window.scrollY > THRESHOLD) btn.classList.add('visible');
        else btn.classList.remove('visible');
      }
      function scrollToTop(){
        window.scrollTo({top:0, behavior:'smooth'});
      }
      window.addEventListener('scroll', updateVisibility);
      btn.addEventListener('click', scrollToTop);
      updateVisibility();
    })();
  </script>

  <script>
    const STORAGE_KEY = 'ms-maintenance-logs';

    function loadRecords(){
      try{
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      }catch(e){
        console.error(e);
        return [];
      }
    }

    function saveRecords(arr){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }

    function updateStatus(msg){
      const el = document.getElementById('status');
      if (!el) return;
      const logs = loadRecords();
      el.innerHTML = msg + '<br><strong>Total records: ' + logs.length + '</strong>';
    }

    function setToday(){
      const input = document.getElementById('dateInput');
      if (!input) return;
      if (!input.value){
        const today = new Date().toISOString().slice(0,10);
        input.value = today;
      }
    }

    // 讀取網址 ?asset=PC-xxx
    function getAssetIdFromQuery(){
      const params = new URLSearchParams(window.location.search);
      const asset = params.get('asset');
      if (!asset) return '';
      return normalizeAssetId(asset);
    }

    // Asset ID 標準化：PC-001 ~ PC-999
    function normalizeAssetId(input) {
      if (!input) return "";

      let v = String(input).trim().toUpperCase();

      // 已經是 PC-001 格式
      if (/^PC-\d{3}$/.test(v)) return v;

      // 把 PC 前綴拿掉，只留數字
      v = v.replace(/^PC/i, "").replace(/[^0-9]/g, "");

      if (!v) return "";

      const num = parseInt(v, 10);
      if (!Number.isFinite(num) || num < 1 || num > 999) {
        return "";
      }

      return "PC-" + String(num).padStart(3, "0");
    }

    function saveRecord(){
      const date      = document.getElementById('dateInput').value;
      const line      = document.getElementById('lineInput').value;
      const section   = document.getElementById('sectionInput').value;

      const equipInputEl = document.getElementById('equipInput');
      const rawEquip     = equipInputEl.value;
      const assetId      = normalizeAssetId(rawEquip);   // 轉成 PC-xxx

      const category  = document.getElementById('catInput').value;
      const downtime  = Number(document.getElementById('downInput').value || 0);
      const rootcause = document.getElementById('rootInput').value.trim();
      const action    = document.getElementById('actionInput').value.trim();
      const loc_from  = document.getElementById('locFromInput').value.trim();
      const loc_to    = document.getElementById('locToInput').value.trim();

      // 沒填日期或 Asset ID 格式不正確
      if (!date || !assetId){
        updateStatus(
          'Please fill <strong>Date</strong> and a valid <strong>Asset ID</strong> (PC-001 ~ PC-999).'
        );
        return;
      }

      // 把格式化好的字串回寫到輸入框，讓畫面也看到 PC-0xx
      equipInputEl.value = assetId;

      const record = {
        Date: date,
        line,
        section,
        asset_id: assetId,
        category,
        downtime_min: downtime,
        root_cause: rootcause,
        action_taken: action,
        location_from: loc_from,
        location_to: loc_to,
        timestamp: new Date().toISOString(),
        id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : ('rec_' + Date.now())
      };

      const logs = loadRecords();
      logs.push(record);
      saveRecords(logs);

      // 清掉其他欄位（Asset ID 留著，方便連續記錄同一台）
      document.getElementById('downInput').value = '';
      document.getElementById('rootInput').value = '';
      document.getElementById('actionInput').value = '';
      document.getElementById('locFromInput').value = '';
      document.getElementById('locToInput').value = '';

      updateStatus('Record saved locally.');
    }

    function downloadJson(){
      const logs = loadRecords();
      const blob = new Blob([JSON.stringify(logs, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'maintenance_logs.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      updateStatus('JSON file downloaded. You can use it in Python / Excel.');
    }

    (function init(){
      setToday();

      // 從網址帶進來的 ?asset=PC-xxx 自動填入
      const fromUrl = getAssetIdFromQuery();
      if (fromUrl) {
        const equipInputEl = document.getElementById('equipInput');
        if (equipInputEl) equipInputEl.value = fromUrl;
      }

      // Asset ID 欄位 blur 時自動整理成標準格式（如果合法）
      const equipInputEl = document.getElementById('equipInput');
      if (equipInputEl) {
        equipInputEl.addEventListener('blur', ()=>{
          const formatted = normalizeAssetId(equipInputEl.value);
          if (formatted) {
            equipInputEl.value = formatted;
          } else {
            equipInputEl.value = equipInputEl.value.trim().toUpperCase();
          }
        });
      }

      updateStatus('Ready to record maintenance tasks.');
    })();
  </script>
</body>
</html>
