<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Maintenance Smart | Maintenance Records</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Apply theme & style from portal -->
  <script>
    (function () {
      const storedTheme = localStorage.getItem('ms-theme');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = storedTheme || (prefersDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);

      const style = localStorage.getItem('ms-style') || 'blue';
      document.documentElement.setAttribute('data-style', style);
    })();
  </script>

  <style>
    :root {
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --border-subtle: #e5e7eb;
      --accent: #2563eb;
      --accent-hover: #1d4ed8;
      --text: #111827;
      --text-soft: #6b7280;
      --radius-xl: 16px;
      --shadow-soft-sm: 0 8px 20px rgba(15,23,42,0.06);
      --small-font: 13px;
      --xsmall-font: 11px;
    }

    html[data-theme="dark"] {
      --bg: #020617;
      --card-bg: #020617;
      --border-subtle: #1f2937;
      --accent: #60a5fa;
      --accent-hover: #3b82f6;
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --shadow-soft-sm: 0 8px 20px rgba(0,0,0,0.75);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 15px;
      background:
        radial-gradient(circle at top, rgba(129,140,248,0.14), transparent),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
      -webkit-text-size-adjust: 100%;
      transition: background .25s ease, color .25s ease;
    }

    html[data-style="panther"] body {
      background:
        radial-gradient(circle at top, rgba(244,114,182,.28), transparent),
        var(--bg);
    }
    html[data-style="hangyodon"] body {
      background:
        radial-gradient(circle at top, rgba(56,189,248,.35), transparent),
        var(--bg);
    }

    .side-panther,
    .side-hangyodon{
      position:fixed;
      top:50%;
      transform:translateY(-50%);
      width:360px;
      opacity:.9;
      z-index:1;
      pointer-events:none;
      user-select:none;
      display:none;
      transition:transform .25s ease, opacity .25s ease;
    }
    .side-panther.left{left:1.5%;transform:translateY(-50%) scaleX(1)}
    .side-panther.right{right:1.5%;transform:translateY(-50%) scaleX(1)}
    .side-hangyodon.left{left:1.5%;transform:translateY(-50%) scaleX(-1)}
    .side-hangyodon.right{right:1.5%;transform:translateY(-50%) scaleX(-1)}

    html[data-style="panther"] .side-panther{display:block;}
    html[data-style="hangyodon"] .side-hangyodon{display:block;}

    @media (max-width: 900px){
      html[data-style="panther"] .side-panther.left,
      html[data-style="hangyodon"] .side-hangyodon.left{
        display:none !important;
      }

      html[data-style="panther"] .side-panther.right,
      html[data-style="hangyodon"] .side-hangyodon.right{
        display:block !important;
        position:fixed !important;
        left:50% !important;
        right:auto !important;
        top:50% !important;
        transform:translate(-50%, -50%) !important;
        width:260px;
        opacity:0.9;
        pointer-events:none;
        z-index:1;
      }
    }

    .page {
      position:relative;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px 16px 32px;
      z-index:2;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-xl);
      border: 1px solid var(--border-subtle);
      padding: 14px;
      box-shadow: var(--shadow-soft-sm);
      margin-bottom: 14px;
      transition: background .25s ease, border-color .25s ease, box-shadow .25s ease;
    }

    .card h2 {
      margin: 0 0 4px;
      font-size: 17px;
      font-weight: 600;
      color: var(--text);
    }

    .card-subtitle {
      font-size: var(--small-font);
      color: var(--text-soft);
      margin-bottom: 8px;
    }

    .summary-chip{
      display:inline-flex;
      flex-wrap:wrap;
      align-items:center;
      gap:6px;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid var(--border-subtle);
      background:#f9fafb;
      font-size:var(--xsmall-font);
      color:var(--text-soft);
    }
    .summary-chip strong{
      color:var(--text);
      font-weight:600;
    }

    .header-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:8px;
    }

    /* Filters */
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 6px;
    }

    .filters-label {
      font-size: var(--xsmall-font);
      color: var(--text-soft);
      margin-right: 2px;
    }

    .filters input,
    .filters select {
      font-size: var(--small-font);
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      color: var(--text);
      min-width: 150px;
      transition: all 0.15s ease;
    }

    html[data-theme="dark"] .filters input,
    html[data-theme="dark"] .filters select {
      background:#020617;
      border-color:#1f2937;
      color:var(--text);
    }

    .filters input::placeholder { color: #9ca3af; }

    .filters input:focus,
    .filters select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(37,99,235,0.14);
      outline: none;
      transform: translateY(-1px);
    }

    .btn {
      cursor: pointer;
      border-radius: 999px;
      padding: 7px 13px;
      font-size: var(--xsmall-font);
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s ease;
      background: #e5e7eb;
      color: #111827;
      font-weight:600;
    }

    .btn:hover {
      background: #d1d5db;
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(148,163,253,0.35);
    }

    .btn-primary {
      background: var(--accent);
      color: #ffffff;
      box-shadow: 0 4px 12px rgba(37,99,235,0.35);
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    .table-wrap {
      margin-top: 4px;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      overflow-x: auto;
      background: #ffffff;
      box-shadow: var(--shadow-soft-sm);
    }
    html[data-theme="dark"] .table-wrap {
      background:#020617;
      border-color:#1f2937;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: var(--small-font);
    }

    thead { background: #f9fafb; }
    html[data-theme="dark"] thead { background:#020617; }

    th, td {
      padding: 8px 9px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }
    html[data-theme="dark"] th,
    html[data-theme="dark"] td{
      border-bottom-color:#1f2937;
    }

    th {
      font-size: var(--xsmall-font);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-soft);
      position: sticky;
      top: 0;
      z-index: 5;
      cursor: pointer;
      user-select: none;
    }

    th.sortable:hover {
      color: var(--accent);
      background: #eef2ff;
    }

    th .sort-indicator{
      font-size:10px;
      margin-left:4px;
      opacity:.6;
    }

    tbody tr{
      transition:background .15s ease, transform .15s ease, box-shadow .15s ease;
    }
    tbody tr:nth-child(even){background:#ffffff;}
    tbody tr:nth-child(odd){background:#fdfdfd;}
    html[data-theme="dark"] tbody tr:nth-child(even),
    html[data-theme="dark"] tbody tr:nth-child(odd){background:transparent;}
    tbody tr:hover{
      background:#eff6ff;
      transform:translateY(-1px);
      box-shadow:0 4px 10px rgba(148,163,253,0.25);
    }
    html[data-theme="dark"] tbody tr:hover{
      background:rgba(37,99,235,.25);
    }

    td{
      max-width:260px;
      overflow:hidden;
      text-overflow:ellipsis;
      color:var(--text);
      vertical-align:top;
    }

    .tag-line{
      font-size:var(--xsmall-font);
      color:#2563eb;
      font-weight:600;
      margin-bottom:2px;
    }
    .text-small{
      font-size:var(--xsmall-font);
      color:var(--text-soft);
    }
    .equip{
      font-weight:600;
    }

    .pill-cat{
      display:inline-flex;
      padding:3px 8px;
      border-radius:999px;
      font-size:var(--xsmall-font);
      background:#eef2ff;
      color:#3730a3;
    }

    .btn-ghost{
      border:none;
      border-radius:999px;
      padding:4px 8px;
      font-size:10px;
      cursor:pointer;
      background:#e5e7eb;
      color:#374151;
      margin-right:4px;
      transition:background .15s, transform .05s;
    }
    .btn-ghost:hover{
      background:#d1d5db;
      transform:translateY(-1px);
    }
    .btn-danger{
      background:#fee2e2;
      color:#b91c1c;
    }
    .btn-danger:hover{
      background:#fecaca;
    }

    .empty{
      padding:30px 16px;
      text-align:center;
      font-size:var(--small-font);
      color:var(--text-soft);
    }

    /* Modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.35);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:20;
    }
    .modal-backdrop.open{display:flex;}
    .modal{
      background:var(--card-bg);
      border-radius:18px;
      padding:16px 18px 14px;
      border:1px solid var(--border-subtle);
      box-shadow:0 20px 45px rgba(15,23,42,.35);
      width:100%;
      max-width:460px;
    }
    .modal-title{
      margin:0 0 4px;
      font-size:16px;
      font-weight:650;
    }
    .modal-sub{
      margin:0 0 10px;
      font-size:var(--xsmall-font);
      color:var(--text-soft);
    }
    .modal-row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .modal-row > div{flex:1;}
    .modal-actions{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:8px;
    }

    @media (max-width: 900px){
      .table-wrap{border-radius:14px;overflow-x:auto;}
      table{min-width:1000px;}
    }

    /* Back to top */
    #backToTop {
      position: fixed;
      bottom: 22px;
      right: 22px;
      width: 58px;
      height: 58px;
      border-radius: 50%;
      border: none;
      background: var(--accent);
      color: #fff;
      font-size: 22px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 20px rgba(0,0,0,0.25);
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s ease, transform .25s ease, box-shadow .25s ease;
    }
    #backToTop.visible{opacity:1;pointer-events:auto;}
    #backToTop:hover{
      transform:translateY(-4px);
      box-shadow:0 10px 28px rgba(0,0,0,0.30);
    }
    html[data-style="panther"] #backToTop{
      background:transparent;
      background-image:url("pinkpanther2.png");
      background-size:100% 100%;
      background-position:center;
      color:transparent;
      border:none;
    }
    html[data-style="hangyodon"] #backToTop{
      background:transparent;
      background-image:url("hangyodon2.png");
      background-size:100% 100%;
      background-position:center;
      color:transparent;
      border:none;
    }

    @media print{
      body{
        background:#ffffff !important;
        -webkit-print-color-adjust:exact;
        print-color-adjust:exact;
      }
      .side-panther,
      .side-hangyodon,
      #backToTop{
        display:none !important;
      }
      .page{
        max-width:100%;
        padding:0;
      }
      .card{
        box-shadow:none;
        border-radius:0;
        margin:0 0 8px;
      }
      .table-wrap{
        box-shadow:none;
        border-radius:0;
        border:1px solid #000;
      }
      th,td{
        border-color:#000 !important;
        color:#000 !important;
      }
      .pill-cat{
        border:1px solid #000 !important;
        background:#fff !important;
        color:#000 !important;
      }
    }
  </style>
</head>
<body>

  <!-- side characters -->
  <img src="pinkpanther1.png" alt="Pink Panther Left" class="side-panther left">
  <img src="pinkpanther2.png" alt="Pink Panther Right" class="side-panther right">
  <img src="hangyodon1.png" alt="Hangyodon Left" class="side-hangyodon left">
  <img src="hangyodon2.png" alt="Hangyodon Right" class="side-hangyodon right">

  <div class="page">
    <div class="card">
      <div class="header-row">
        <div>
          <h2>Maintenance records</h2>
          <div class="card-subtitle">
            Logs are loaded from the <strong>SQLite backend</strong> first,
            then cached in <strong>ms-maintenance-logs</strong> in this browser.
          </div>
        </div>
        <div class="summary-chip">
          Total: <strong id="sumTotal">0</strong>
          · This month: <strong id="sumMonth">0</strong>
          · This month downtime: <strong id="sumMonthDown">0</strong> min
        </div>
      </div>

      <div class="filters">
        <span class="filters-label">Filter:</span>
        <input id="searchInput" type="search" placeholder="Search asset ID / root cause / action / location">
        <select id="lineFilter">
          <option value="">All lines</option>
        </select>
        <select id="sectionFilter">
          <option value="">All sections</option>
        </select>
        <select id="categoryFilter">
          <option value="">All categories</option>
        </select>
        <button class="btn" id="btnClearFilters">Clear filters</button>
      </div>
    </div>

    <div class="card">
      <h2>Record list</h2>
      <div class="card-subtitle">
        Click column headers to sort. Click a row or use Edit / Delete to update the local log.
      </div>
      <div class="table-wrap">
        <div class="empty" id="emptyState">
          No maintenance records found. Create records in <strong>Maintenance Report</strong> first.
        </div>
        <table id="recordsTable" style="display:none;">
          <thead>
            <tr>
              <th class="sortable" data-sort="Date">Date<span class="sort-indicator"></span></th>
              <th class="sortable" data-sort="line">Line / Section<span class="sort-indicator"></span></th>
              <th class="sortable" data-sort="asset_id">Asset ID<span class="sort-indicator"></span></th>
              <th class="sortable" data-sort="category">Category<span class="sort-indicator"></span></th>
              <th class="sortable" data-sort="downtime_min">Downtime (min)<span class="sort-indicator"></span></th>
              <th>Location</th>
              <th>Root cause / Action</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="recordsBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Edit modal -->
  <div class="modal-backdrop" id="editBackdrop">
    <div class="modal">
      <h2 class="modal-title">Edit record</h2>
      <p class="modal-sub">Update the selected maintenance record and save changes (local only for now).</p>

      <div class="modal-row">
        <div>
          <label for="editDate">Date</label>
          <input id="editDate" type="date">
        </div>
        <div>
          <label for="editLine">Line</label>
          <select id="editLine">
            <option value="Line1">Line 1</option>
            <option value="Line2">Line 2</option>
            <option value="Line3">Line 3</option>
            <option value="Line4">Line 4</option>
            <option value="Reclaim">Reclaim</option>
          </select>
        </div>
      </div>

      <div class="modal-row" style="margin-top:8px;">
        <div>
          <label for="editSection">Section</label>
          <select id="editSection">
            <option value="F12">F12</option>
            <option value="F13">F13</option>
            <option value="F16">F16</option>
            <option value="F201">F201</option>
            <option value="F42">F42</option>
            <option value="F55">F55</option>
          </select>
        </div>
        <div>
          <label for="editCategory">Category</label>
          <select id="editCategory">
            <option>Electrical</option>
            <option>Mechanical</option>
            <option>Instrument</option>
            <option>Network</option>
            <option>Software</option>
            <option>Other</option>
          </select>
        </div>
      </div>

      <div style="margin-top:8px;">
        <label for="editAssetId">Asset ID</label>
        <input id="editAssetId" type="text" placeholder="PC-001 ~ PC-999">
      </div>

      <div class="modal-row" style="margin-top:8px;">
        <div>
          <label for="editLocFrom">Location from</label>
          <input id="editLocFrom" type="text" placeholder="e.g. Line 2 MCC">
        </div>
        <div>
          <label for="editLocTo">Location to</label>
          <input id="editLocTo" type="text" placeholder="e.g. Line 2 control room">
        </div>
      </div>

      <div style="margin-top:8px;">
        <label for="editRoot">Root cause</label>
        <textarea id="editRoot" rows="3"></textarea>
      </div>

      <div style="margin-top:8px;">
        <label for="editAction">Action taken</label>
        <textarea id="editAction" rows="3"></textarea>
      </div>

      <div class="modal-actions">
        <button class="btn" type="button" id="btnCancelEdit">Cancel</button>
        <button class="btn btn-primary" type="button" id="btnSaveEdit">Save</button>
      </div>
    </div>
  </div>

  <!-- Back to Top -->
  <button id="backToTop" title="Back to Top">↑</button>

  <script>
    // Back to top
    (function(){
      const btn = document.getElementById('backToTop');
      if (!btn) return;
      const THRESHOLD = 250;
      function updateVisibility(){
        if (window.scrollY > THRESHOLD) btn.classList.add('visible');
        else btn.classList.remove('visible');
      }
      function scrollToTop(){
        window.scrollTo({top:0, behavior:'smooth'});
      }
      window.addEventListener('scroll', updateVisibility);
      btn.addEventListener('click', scrollToTop);
      updateVisibility();
    })();
  </script>

  <script>
  const STORAGE_KEY   = 'ms-maintenance-logs';

  // ✅ 現在連到你本機的 Node + SQLite
  const API_BASE_URL = 'https://maintenance-backend-kh4z.onrender.com';
  const LOGS_ENDPOINT = API_BASE_URL + '/logs';


  let records   = [];
  let filtered  = [];
  let sortKey   = 'Date';
  let sortDir   = 'desc';
  let editingId = null;
  let searchTimer = null;

  // ===== URL ?asset=PC-xxx =====
  function getAssetIdFromQuery(){
    const params = new URLSearchParams(window.location.search);
    return params.get('asset') || '';
  }

  // ===== Asset ID 正規化 PC-001 ~ PC-999 =====
  function normalizeAssetId(raw){
    if (!raw) return '';
    let s = String(raw).trim().toUpperCase();

    if (/^\d{1,3}$/.test(s)) {
      s = 'PC-' + s.padStart(3, '0');
    }

    const m = s.match(/^PC[-\s]?(\d{1,3})$/i);
    if (m) {
      s = 'PC-' + m[1].padStart(3, '0');
    }
    return s;
  }

  function validateAndFormatAssetId(input){
    const formatted = normalizeAssetId(input);
    if (!formatted || !/^PC-\d{3}$/.test(formatted)) {
      alert('Asset ID must be in format: PC-001 ~ PC-999');
      return null;
    }
    return formatted;
  }

  // ===== 統一舊/新欄位格式 =====
  function normalizeRecord(rec, idx){
    const dateVal = rec.Date || rec.date || '';

    const assetRaw = rec.asset_id || rec.equipment || '';
    const assetId  = normalizeAssetId(assetRaw);

    let dt = 0;
    if (rec.downtime_min != null) dt = rec.downtime_min;
    else if (rec.downtime != null) dt = rec.downtime;

    const root = rec.root_cause   || rec.rootcause   || '';
    const act  = rec.action_taken || rec.action      || '';

    const line    = rec.line    || '';
    const section = rec.section || '';
    const cat     = rec.category || '';
    const locFrom = rec.location_from || '';
    const locTo   = rec.location_to   || '';
    const ts      = rec.timestamp || '';

    let id = rec.id;
    if (!id){
      if (window.crypto && crypto.randomUUID){
        id = crypto.randomUUID();
      }else{
        id = 'rec_' + Date.now() + '_' + idx;
      }
    }

    return {
      Date: dateVal,
      line,
      section,
      asset_id: assetId,
      category: cat,
      downtime_min: Number(dt) || 0,
      root_cause:   root,
      action_taken: act,
      location_from: locFrom,
      location_to:   locTo,
      timestamp: ts,
      id
    };
  }

  // ===== localStorage 版：只負責本機快取 =====
  function loadRecordsFromLocal(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY) || '[]';
      const arr = JSON.parse(raw);
      if (!Array.isArray(arr)) return [];

      const normalized = arr.map((rec, idx)=> normalizeRecord(rec, idx));
      localStorage.setItem(STORAGE_KEY, JSON.stringify(normalized));
      return normalized;
    }catch(e){
      console.error(e);
      return [];
    }
  }

  function saveRecordsToLocal(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
  }

  // ===== Server API 呼叫 =====
  async function fetchServerLogs(){
    const res = await fetch(LOGS_ENDPOINT, {
      method: 'GET',
      headers: { 'Accept': 'application/json' }
    });
    if (!res.ok){
      throw new Error('Server error: ' + res.status);
    }
    const data = await res.json();
    // 你的後端格式：{ ok:true, data:[...] }
    if (data && data.ok && Array.isArray(data.data)) {
      return data.data.map((rec, idx)=> normalizeRecord(rec, idx));
    }
    console.warn('Unexpected /logs response:', data);
    return [];
  }

  // 現在先不對伺服器做編輯/刪除，只在本機改
  async function updateOnServer(rec){
    console.log('Update on server not implemented yet. Local-only edit.', rec);
  }

  async function deleteOnServer(id){
    console.log('Delete on server not implemented yet. Local-only delete.', id);
  }

  // ===== 自動產生 filter 選項 =====
  function populateFilterOptions(){
    const lineSel = document.getElementById('lineFilter');
    const secSel  = document.getElementById('sectionFilter');
    const catSel  = document.getElementById('categoryFilter');

    if (!lineSel || !secSel || !catSel) return;

    const currentLine = lineSel.value;
    const currentSec  = secSel.value;
    const currentCat  = catSel.value;

    const lines = new Set();
    const secs  = new Set();
    const cats  = new Set();

    records.forEach(r=>{
      if (r.line)    lines.add(r.line);
      if (r.section) secs.add(r.section);
      if (r.category)cats.add(r.category);
    });

    function resetSelect(sel){
      while (sel.options.length > 1) sel.remove(1);
    }
    resetSelect(lineSel);
    resetSelect(secSel);
    resetSelect(catSel);

    [...lines].sort().forEach(v=>{
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = v;
      lineSel.appendChild(opt);
    });
    [...secs].sort().forEach(v=>{
      const opt = document.createElement('option');
      opt.value = v;
      secSel.appendChild(opt);
    });
    [...cats].sort().forEach(v=>{
      const opt = document.createElement('option');
      opt.value = v;
      catSel.appendChild(opt);
    });

    if ([...lineSel.options].some(o=>o.value === currentLine)) lineSel.value = currentLine;
    else lineSel.value = '';
    if ([...secSel.options].some(o=>o.value === currentSec))   secSel.value = currentSec;
    else secSel.value = '';
    if ([...catSel.options].some(o=>o.value === currentCat))   catSel.value = currentCat;
    else catSel.value = '';
  }

  function applyFilters(){
    const q  = document.getElementById('searchInput').value.trim().toLowerCase();
    const lf = document.getElementById('lineFilter').value;
    const sf = document.getElementById('sectionFilter').value;
    const cf = document.getElementById('categoryFilter').value;

    filtered = records.filter(r=>{
      if (lf && r.line !== lf) return false;
      if (sf && r.section !== sf) return false;
      if (cf && r.category !== cf) return false;

      if (q){
        const hay = (
          (r.asset_id||'')+' '+
          (r.root_cause||'')+' '+
          (r.action_taken||'')+' '+
          (r.location_from||'')+' '+
          (r.location_to||'')
        ).toLowerCase();
        if (!hay.includes(q)) return false;
      }
      return true;
    });

    sortFiltered();
    renderTable();
    updateSummary();
  }

  function onSearchInput(){
    clearTimeout(searchTimer);
    searchTimer = setTimeout(applyFilters, 200);
  }

  function sortFiltered(){
    filtered.sort((a,b)=>{
      let va = a[sortKey];
      let vb = b[sortKey];

      if (sortKey === 'Date'){
        va = new Date(a.Date || a.date || 0).getTime();
        vb = new Date(b.Date || b.date || 0).getTime();
      } else if (sortKey === 'downtime_min'){
        va = Number(a.downtime_min || a.downtime || 0);
        vb = Number(b.downtime_min || b.downtime || 0);
      } else {
        if (typeof va === 'string') va = va.toLowerCase();
        if (typeof vb === 'string') vb = vb.toLowerCase();
      }

      if (va < vb) return sortDir === 'asc' ? -1 : 1;
      if (va > vb) return sortDir === 'asc' ? 1 : -1;
      return 0;
    });

    document.querySelectorAll('th.sortable').forEach(th=>{
      const key = th.dataset.sort;
      const span = th.querySelector('.sort-indicator');
      if (!span) return;
      if (key === sortKey){
        span.textContent = sortDir === 'asc' ? '▲' : '▼';
      }else{
        span.textContent = '';
      }
    });
  }

  function formatDate(s){
    if (!s) return '';
    const d = new Date(s);
    if (isNaN(d.getTime())) return s;
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  function renderTable(){
    const tbody = document.getElementById('recordsBody');
    const table = document.getElementById('recordsTable');
    const empty = document.getElementById('emptyState');

    tbody.innerHTML = '';

    if (!filtered.length){
      table.style.display = 'none';
      empty.style.display = 'block';
      return;
    }
    table.style.display = 'table';
    empty.style.display = 'none';

    filtered.forEach(rec=>{
      const tr = document.createElement('tr');
      tr.dataset.id = rec.id;

      tr.addEventListener('click', ()=> openEdit(rec.id));

      const tdDate = document.createElement('td');
      tdDate.className = 'text-small';
      tdDate.textContent = formatDate(rec.Date);
      tr.appendChild(tdDate);

      const tdLS = document.createElement('td');
      const divLine = document.createElement('div');
      divLine.className = 'tag-line';
      divLine.textContent = rec.line || '';
      const divSec = document.createElement('div');
      divSec.className = 'text-small';
      divSec.textContent = rec.section || '';
      tdLS.appendChild(divLine);
      tdLS.appendChild(divSec);
      tr.appendChild(tdLS);

      const tdEquip = document.createElement('td');
      tdEquip.className = 'equip';
      tdEquip.textContent = rec.asset_id || '';
      tr.appendChild(tdEquip);

      const tdCat = document.createElement('td');
      const spanCat = document.createElement('span');
      spanCat.className = 'pill-cat';
      spanCat.textContent = rec.category || '';
      tdCat.appendChild(spanCat);
      tr.appendChild(tdCat);

      const tdDown = document.createElement('td');
      tdDown.className = 'text-small';
      tdDown.textContent = Number(rec.downtime_min||0);
      tr.appendChild(tdDown);

      const tdLoc = document.createElement('td');
      tdLoc.className = 'text-small';
      const lf = document.createElement('div');
      lf.innerHTML = '<strong>From:</strong> ' + (rec.location_from || '');
      const lt = document.createElement('div');
      lt.innerHTML = '<strong>To:</strong> ' + (rec.location_to || '');
      tdLoc.appendChild(lf);
      tdLoc.appendChild(lt);
      tr.appendChild(tdLoc);

      const tdDesc = document.createElement('td');
      tdDesc.className = 'text-small';
      const d1 = document.createElement('div');
      d1.innerHTML = '<strong>Root:</strong> ' + (rec.root_cause||'');
      const d2 = document.createElement('div');
      d2.innerHTML = '<strong>Action:</strong> ' + (rec.action_taken||'');
      tdDesc.appendChild(d1);
      tdDesc.appendChild(d2);
      tr.appendChild(tdDesc);

      const tdAct = document.createElement('td');
      const btnE = document.createElement('button');
      btnE.className = 'btn-ghost';
      btnE.textContent = 'Edit';
      btnE.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        openEdit(rec.id);
      });
      const btnD = document.createElement('button');
      btnD.className = 'btn-ghost btn-danger';
      btnD.textContent = 'Delete';
      btnD.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        deleteRecord(rec.id);
      });
      tdAct.appendChild(btnE);
      tdAct.appendChild(btnD);
      tr.appendChild(tdAct);

      tbody.appendChild(tr);
    });
  }

  function updateSummary(){
    const totalEl     = document.getElementById('sumTotal');
    const monthEl     = document.getElementById('sumMonth');
    const monthDownEl = document.getElementById('sumMonthDown');
    totalEl.textContent = records.length;

    const now = new Date();
    const ym  = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0');
    let cnt = 0;
    let down = 0;
    records.forEach(r=>{
      if (!r.Date) return;
      const d = new Date(r.Date);
      if (isNaN(d.getTime())) return;
      const m = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
      if (m === ym) {
        cnt++;
        down += Number(r.downtime_min || 0) || 0;
      }
    });
    monthEl.textContent = cnt;
    monthDownEl.textContent = down;
  }

  function clearFilters(){
    document.getElementById('searchInput').value = '';
    document.getElementById('lineFilter').value = '';
    document.getElementById('sectionFilter').value = '';
    document.getElementById('categoryFilter').value = '';
    applyFilters();
  }

  async function deleteRecord(id){
    if (!confirm('Delete this record from local cache?')) return;
    records = records.filter(r=>r.id !== id);
    saveRecordsToLocal();
    populateFilterOptions();
    applyFilters();

    deleteOnServer(id); // 目前只是 console.log
  }

  function openEdit(id){
    const rec = records.find(r=>r.id === id);
    if (!rec) return;
    editingId = id;

    document.getElementById('editDate').value    = rec.Date ? String(rec.Date).slice(0,10) : '';
    document.getElementById('editLine').value    = rec.line || 'Line1';
    document.getElementById('editSection').value = rec.section || 'F12';
    document.getElementById('editCategory').value= rec.category || 'Other';
    document.getElementById('editAssetId').value = rec.asset_id || '';
    document.getElementById('editLocFrom').value = rec.location_from || '';
    document.getElementById('editLocTo').value   = rec.location_to || '';
    document.getElementById('editRoot').value    = rec.root_cause || '';
    document.getElementById('editAction').value  = rec.action_taken || '';

    document.getElementById('editBackdrop').classList.add('open');
  }

  function closeEdit(){
    editingId = null;
    document.getElementById('editBackdrop').classList.remove('open');
  }

  async function saveEdit(){
    if (!editingId) return;
    const idx = records.findIndex(r=>r.id === editingId);
    if (idx === -1) return;

    const rec = records[idx];

    const formattedAssetId = validateAndFormatAssetId(
      document.getElementById('editAssetId').value
    );
    if (formattedAssetId === null) return;

    rec.Date          = document.getElementById('editDate').value || rec.Date;
    rec.line          = document.getElementById('editLine').value;
    rec.section       = document.getElementById('editSection').value;
    rec.category      = document.getElementById('editCategory').value;
    rec.asset_id      = formattedAssetId;
    rec.location_from = document.getElementById('editLocFrom').value.trim();
    rec.location_to   = document.getElementById('editLocTo').value.trim();
    rec.root_cause    = document.getElementById('editRoot').value.trim();
    rec.action_taken  = document.getElementById('editAction').value.trim();

    records[idx] = rec;
    saveRecordsToLocal();
    populateFilterOptions();
    applyFilters();
    closeEdit();

    updateOnServer(rec); // 目前只是 console.log
  }

  // ===== init：優先讀伺服器，失敗再用 localStorage =====
  (async function init(){
    try{
      const serverLogs = await fetchServerLogs();
      records = serverLogs;
      saveRecordsToLocal();           // 伺服器成功 → 更新 localStorage 快取
    }catch(e){
      console.warn('Load from server failed, fallback to localStorage.', e);
      records = loadRecordsFromLocal();
    }

    filtered = [...records];
    populateFilterOptions();

    const assetFromUrl = getAssetIdFromQuery();
    if (assetFromUrl){
      const searchEl = document.getElementById('searchInput');
      if (searchEl) searchEl.value = assetFromUrl;
    }

    document.getElementById('searchInput').addEventListener('input', onSearchInput);
    document.getElementById('lineFilter').addEventListener('change', applyFilters);
    document.getElementById('sectionFilter').addEventListener('change', applyFilters);
    document.getElementById('categoryFilter').addEventListener('change', applyFilters);
    document.getElementById('btnClearFilters').addEventListener('click', clearFilters);

    document.querySelectorAll('th.sortable').forEach(th=>{
      th.addEventListener('click', ()=>{
        const key = th.dataset.sort;
        if (sortKey === key){
          sortDir = sortDir === 'asc' ? 'desc' : 'asc';
        }else{
          sortKey = key;
          sortDir = key === 'Date' ? 'desc' : 'asc';
        }
        sortFiltered();
        renderTable();
      });
    });

    document.getElementById('btnCancelEdit').addEventListener('click', closeEdit);
    document.getElementById('btnSaveEdit').addEventListener('click', saveEdit);
    document.getElementById('editBackdrop').addEventListener('click',(e)=>{
      if (e.target.id === 'editBackdrop') closeEdit();
    });

    applyFilters();
  })();
  </script>
</body>
</html>
